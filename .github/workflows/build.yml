name: Entire Project CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-common:
    uses: ./.github/workflows/publish-crate.yml
    with:
      path: ./example-communication-common
    secrets:
      cargo: ${{ secrets.CARGO_TOKEN }}
  build-server:
    needs: [build-common]
    uses: ./.github/workflows/publish-docker-images.yml
    with:
      path: ./example-communication-server
      image_name: ghcr.io/exlted/example-communication-server
    secrets:
      username: ${{ github.repository_owner }}
      password: ${{ secrets.REGISTRY_SECRET }}
  build-client:
    needs: [build-common]
    uses: houseabsolute/actions-rust-cross@v1.0.5
    with:
      working-directory: ./example-communication-client
      target: 'binary-bin-windows-amd64.exe'
    secrets:
      username: ${{ github.repository_owner }}
      password: ${{ secrets.REGISTRY_SECRET }}
  build-controller:
    needs: [build-common]
    uses: houseabsolute/actions-rust-cross@v1.0.5
    with:
      working-directory: ./example-communication-controller
      target: 'binary-bin-windows-amd64.exe'
    secrets:
      username: ${{ github.repository_owner }}
      password: ${{ secrets.REGISTRY_SECRET }}
